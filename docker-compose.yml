services:
  model-designer:
    # Pre-built image from GitHub Actions (fast — no local build needed)
    # To build locally instead: docker compose -f docker-compose.yml -f docker-compose.build.yml up
    image: ghcr.io/kittawat-thongpud/model-designer:latest
    container_name: model-designer

    # ── Ports ──────────────────────────────────────────────────────────────────
    ports:
      - "8000:8000"

    # ── Persistent data volume ─────────────────────────────────────────────────
    # RunPod Network Volume is mounted at /workspace on the host.
    # Map it to /app/backend/data so DATA_DIR default resolves correctly
    # and all datasets, weights, jobs, logs persist across container restarts.
    volumes:
      - /workspace/data:/app/backend/data

    # ── Environment ────────────────────────────────────────────────────────────
    environment:
      - APP_DIR=/app
      - DATA_DIR=/app/backend/data
      - MODEL_DESIGNER_PYTHON=/opt/venv/bin/python3
      - PYTHONUNBUFFERED=1

    # ── Shared memory (required for multi-GPU DDP via torch.multiprocessing) ───
    shm_size: '2gb'

    # ── GPU ────────────────────────────────────────────────────────────────────
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    restart: unless-stopped
